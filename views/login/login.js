$(document).ready(function(){var clicked=false;function handleLogin(){if(!clicked&&!$("#loginbutton").hasClass("disabled")){var userid=$("#inputUserID").val().toUpperCase();var passcode=$("#inputPasscode").val();if(userid.length==16&&(passcode.length==16||passcode.length==48)){clicked=true;session_step=0;$("#arc0").css("background-color",$("#combinator").css("color"));$("#generatebutton").attr("disabled","disabled");$("#helpbutton").attr("disabled","disabled");$("#combinatorwrap").css("opacity",1);rotate_login(0);setTimeout(function(){main(userid,passcode)},1e3)}}}$("#loginbutton").click(function(){handleLogin(clicked)});$("#inputUserID").keypress(function(e){if(e.keyCode==13){$("#inputPasscode").focus()}});$("#inputPasscode").keypress(function(e){if(e.keyCode==13){$("#loginbutton").focus();handleLogin(clicked)}});$(document).keydown(function(e){var key=undefined;var possible=[e.key,e.keyIdentifier,e.keyCode,e.which];while(key===undefined&&possible.length>0){key=possible.pop()}if(key&&(key=="115"||key=="83")&&(e.ctrlKey||e.metaKey)&&!e.altKey){e.preventDefault();$("#loginbutton").removeAttr("disabled");return false}return true})});init.login=function(args){};function validate_userid(userid){var hxid=base32ToHex(userid).toUpperCase();return DJB2.hash(hxid.substr(0,12)).substr(0,4)==hxid.substr(12,4)?true:false}function validate_passwd(userid,passwd){var hxid=base32ToHex(userid).toLowerCase();var entr=passwd.toUpperCase();return DJB2.hash(hxid.substr(0,12)+entr).substr(4,4)==hxid.substr(16,4).toUpperCase()?true:false}function main(userid,passcode){nacl=nacl_factory.instantiate();blink("arc0");var nonce=nacl.crypto_box_random_nonce();var user_keys=generate_keys(passcode,userid);var user_pubkey=nacl.to_hex(user_keys.boxPk);do_login(user_keys,nonce);continue_session(user_keys,nonce,userid)}function next_step(){var current_session=session_step;session_step++;return current_session+1}function read_session(user_keys,nonce){var sess_bin=nacl.from_hex($("#session_data").text());var session_data=nacl.crypto_box_open(sess_bin,nonce,user_keys.boxPk,user_keys.boxSk);var session_string=nacl.decode_utf8(session_data);return JSON.parse(session_string)}function continue_session(user_keys,nonce,userid){var session_watch=$("#session_data").text();if(session_watch==""){setTimeout(function(){continue_session(user_keys,nonce,userid)},1e3)}else{setTimeout(function(){fetchview("interface",{user_keys:user_keys,nonce:nonce,userid:userid})},3e3)}}function do_login(user_keys,nonce){var session_seed=nacl.random_bytes(4096);var session_keypair=nacl.crypto_box_keypair_from_seed(session_seed);var session_sign_seed=nacl.crypto_hash_sha256(session_seed);var session_signpair=nacl.crypto_sign_keypair_from_seed(session_sign_seed);var session_nonce=nacl.to_hex(nonce);var session_hexkey=nacl.to_hex(session_keypair.boxPk);var session_hexsign=nacl.to_hex(session_signpair.signPk);var session_seckey=nacl.to_hex(session_keypair.boxSk);var session_secsign=nacl.to_hex(session_signpair.signSk);dial_login(1);$.ajax({url:path+"x/"+session_hexsign+"/"+session_step,dataType:"json"}).done(function(data){if(clean(data.nonce1).length==48){session_step++;var nonce2=nacl.crypto_box_random_nonce();var nonce2_hex=nacl.to_hex(nonce2);var nonce2_hex=nonce2_hex.replace(/^[8-9a-f]/,function(match){var range=["8","9","a","b","c","d","e","f"];return range.indexOf(match)});var nonce1_hex=clean(data.nonce1);var nonce1=nacl.from_hex(nonce1_hex);var nonce1_hex=nonce1_hex.replace(/^[8-9a-f]/,function(match){var range=["8","9","a","b","c","d","e","f"];return range.indexOf(match)});var secrets_json={nonce1:nonce1_hex,nonce2:nonce2_hex,client_session_pubkey:session_hexkey};var session_secrets=JSON.stringify(secrets_json);var crypt_bin=nacl.encode_utf8(session_secrets);var crypt_response=nacl.crypto_sign(crypt_bin,session_signpair.signSk);var crypt_hex=nacl.to_hex(crypt_response);$.ajax({url:path+"x/"+session_hexsign+"/"+session_step+"/"+crypt_hex,dataType:"json"}).done(function(data){dial_login(2);var server_sign_binkey=nacl.from_hex(clean(data.server_sign_pubkey));var crypt_bin=nacl.from_hex(clean(data.crhex));var crypt_pack=nacl.crypto_sign_open(crypt_bin,server_sign_binkey);var crypt_str=nacl.decode_utf8(crypt_pack);var crypt_vars=JSON.parse(crypt_str);if(crypt_vars.server_sign_pubkey==data.server_sign_pubkey){var key_array={nonce:session_nonce,nonce1:nonce1_hex,nonce2:nonce2_hex,session_secsign:session_secsign,session_seckey:session_seckey,session_pubsign:session_hexsign,session_pubkey:session_hexkey,server_pubsign:crypt_vars.server_sign_pubkey,server_pubkey:crypt_vars.server_session_pubkey};var sess_bin=nacl.encode_utf8(JSON.stringify(key_array));var sess_response=nacl.crypto_box(sess_bin,nonce,user_keys.boxPk,user_keys.boxSk);var sess_hex=nacl.to_hex(sess_response);$("#session_data").text(sess_hex);dial_login(3)}})}})}function generate_keys(secret,salt){var secr_ba=sjcl.codec.utf8String.toBits(secret.toUpperCase());var salt_ba=sjcl.codec.utf8String.toBits(salt.toLowerCase());var key_seed1=sjcl.misc.pbkdf2(secr_ba,salt_ba,5e3,4096,false);var rsecret=secret.toUpperCase().split("").reverse().join("");var rsecr_ba=sjcl.codec.utf8String.toBits(rsecret);var usalt_ba=sjcl.codec.utf8String.toBits(salt.toUpperCase());var key_seed2=sjcl.misc.pbkdf2(rsecr_ba,usalt_ba,5e3,4096,false);var key_seed3=sjcl.misc.pbkdf2(key_seed1,key_seed2,5e3,4096,false);var key_seed_str3=sjcl.codec.hex.fromBits(key_seed3);var final_key_seed=nacl.from_hex(key_seed_str3);var user_key=nacl.crypto_box_keypair_from_seed(final_key_seed);dial_login(0);return user_key}function clean(dirty){var dirty_str=dirty.toString();var clean_str=dirty_str.replace(/[^A-Za-z0-9]/g,"");return clean_str}
