var fs=require("fs");var path=require("path");var scheduler=require("./scheduler");var modulesdirectory=path.normalize(process.cwd()+"/../modules/");var modulelist=[];var module=[];exports.init=init;exports.initexec=initexec;exports.module=module;exports.getsource=getsource;function init(callbackArray){module.length=0;modulelist.length=0;fs.readdir(modulesdirectory,function(err1,files){if(err1){console.log(" [!] warning: error when reading "+err1)}else{console.log(" [.] scanning modules in "+modulesdirectory);files.sort().forEach(scanmodules);modulelist.forEach((element,index,array)=>{console.log(" [.] loading module "+element);module[element]=[];if(fs.existsSync(path.join(modulesdirectory+element+"/package.json"))){module[element].info=function(){return JSON.parse(fs.readFileSync(modulesdirectory+element+"/package.json","utf8"))}}else{console.log(" [!] warning: non-existing "+modulesdirectory+element+"/package.json");module[element].info=null}module[element].main=require(modulesdirectory+element+"/module.js");module[element].main.init()})}functions.sequential(this.callbackArray)}.bind({callbackArray:callbackArray}));return 1}function scanmodules(element,index,array){if(fs.statSync(path.join(modulesdirectory+element)).isDirectory()){if(fs.existsSync(path.join(modulesdirectory+element+"/module.js"))){modulelist.push(element);console.log(" [i] found module "+element)}else{console.log(" [!] cannot load module "+element+"!")}}return 1}function initexec(modulename,command){for(var asset in global.hybridd.asset){if(typeof global.hybridd.asset[asset].module!="undefined"&&global.hybridd.asset[asset].module==modulename){var processID=scheduler.init(0);var target=global.hybridd.asset[asset];target.symbol=asset;var mode=typeof target.mode!="undefined"?target.mode:null;var factor=typeof target.factor!="undefined"?target.factor:8;modules.module[global.hybridd.asset[target.symbol].module].main.exec({processID:processID,target:target,mode:mode,factor:factor,command:command})}}for(var source in global.hybridd.source){if(typeof global.hybridd.source[source].module!="undefined"&&global.hybridd.source[source].module==modulename){var processID=scheduler.init(0);var target=global.hybridd.source[source];target.id=source;var mode=typeof target.mode!="undefined"?target.mode:null;modules.module[global.hybridd.source[target.id].module].main.exec({processID:processID,target:target,mode:mode,factor:factor,command:command})}}return 1}function getsource(mode){mode=mode.split(".")[1];var targets=[];var targetscnt=0;for(var key in global.hybridd.source){if(typeof global.hybridd.source[key].mode!=="undefined"&&global.hybridd.source[key].mode.split(".")[0]===mode){targets.push(key);targetscnt+=1}}var choice=targets[Math.floor(Math.random()*targetscnt)];return global.hybridd.source[choice]}
