exports.initialize=initialize;exports.add=insert;exports.pause=pause;exports.resume=resume;function pause(callbackArray){if(global.hybridd.APIqueueInterval){console.log(" [i] REST API has been paused")}clearInterval(global.hybridd.APIqueueInterval);global.hybridd.APIqueueInterval=null;global.hybridd.APIqueueInitiated=false;functions.sequential(callbackArray)}function resume(callbackArray){if(!global.hybridd.APIqueueInterval){console.log(" [i] REST API has been started");initialize(callbackArray)}else{functions.sequential(callbackArray)}}function httpCall(link,host,qpath,args,method,processID,qid){var postresult;switch(method){case"POST":postresult=link.post(host+qpath,args,function(data,response){restaction({processID:this.processID,qid:this.qid,data:data})}.bind({qid:qid,processID:processID}));break;case"PUT":postresult=link.put(host+qpath,args,function(data,response){restaction({processID:this.processID,qid:this.qid,data:data})}.bind({qid:qid,processID:processID}));break;case"GET":postresult=link.get(host+qpath,{},function(data,response){restaction({processID:this.processID,qid:this.qid,data:data})}.bind({qid:qid,processID:processID}));break}postresult.once("error",result=>{console.log(` [!] API queue -> ${result}`)})}function webSocketCall(link,host,qpath,args,method,processID,qid){link.on("message",function(data){restaction({processID:this.processID,qid:this.qid,data:data})}.bind({qid:qid,processID:processID}));link.send(JSON.stringify(args.data))}function initialize(callbackArray){var timer=500;global.hybridd.APIqueueInterval=setInterval(function(){if(!global.hybridd.APIqueueInitiated){console.log(` [i] REST API running on: http://${global.hybridd.restbind}:${global.hybridd.restport}`);global.hybridd.APIqueueInitiated=true;functions.sequential(callbackArray)}var timenow=Date.now();for(var qid in global.hybridd.APIqueue){var target=global.hybridd.APIqueue[qid].target;var base=target.split(".")[0];var timestamp=global.hybridd.APIqueue[qid].time;var processID=global.hybridd.APIqueue[qid].pid;var timeout=timestamp+global.hybridd.APIqueue[qid].timeout;if(timeout>timenow&&global.hybridd.APIqueue[qid].retries<global.hybridd.APIqueue[qid].retry){if(typeof global.hybridd.APIthrottle[base]==="undefined"){global.hybridd.APIthrottle[base]=0}if(global.hybridd.APIqueue[qid].next<timenow&&global.hybridd.APIthrottle[base]<timenow){try{global.hybridd.APIqueue[qid].retries++;global.hybridd.APIqueue[qid].next=timenow+Number(global.hybridd.APIqueue[qid].interval*(global.hybridd.APIqueue[qid].retries+1));if(global.hybridd.APIthrottle[base]<timenow+timer/1e3*global.hybridd.APIqueue[qid].throttle){global.hybridd.APIthrottle[base]=timenow+timer/1e3*global.hybridd.APIqueue[qid].throttle}if(typeof global.hybridd.APIqueue[qid].host==="string"){var host=global.hybridd.APIqueue[qid].host}else{var host=global.hybridd.APIqueue[qid].host[global.hybridd.APIqueue[qid].reqcnt];if(global.hybridd.APIqueue[qid].reqcnt<global.hybridd.APIqueue[qid].host.length-1){global.hybridd.APIqueue[qid].reqcnt+=1}else{global.hybridd.APIqueue[qid].reqcnt=0}}var args=global.hybridd.APIqueue[qid].args;var method=global.hybridd.APIqueue[qid].method;var qpath=typeof args.path==="undefined"?"":args.path;var link;if(global.hybridd.APIqueue[qid].link){link=new Function(`return global.hybridd.${global.hybridd.APIqueue[qid].link}.link;`)()}else{var Client=require("./rest").Client;link=new Client}if(host.substr(0,5)==="ws://"||host.substr(0,6)==="wss://"){webSocketCall(link,host,qpath,args,method,processID,qid)}else{httpCall(link,host,qpath,args,method,processID,qid)}}catch(result){console.log(` [!] API queue catch -> ${result}`)}}else if(DEBUG){console.log(" [i]  API-QUEUE: WAITING ON "+target+"... "+global.hybridd.APIqueue[qid].retries+"/"+global.hybridd.APIqueue[qid].retry)}}else if(global.hybridd.APIqueue[qid].retries>=global.hybridd.APIqueue[qid].retry){if(DEBUG){console.log(" [!] API-QUEUE: TIMEOUT"+target+" "+processID)}scheduler.stop(processID,{err:1});delete global.hybridd.APIqueue[qid]}}}.bind({callbackArray:callbackArray}),timer);return 1}function restaction(properties){var err=0;try{properties.data=JSON.parse(properties.data)}catch(result){if(typeof properties.data!=="object"){err=1}}if(err===0){delete global.hybridd.APIqueue[properties.qid];scheduler.stop(properties.processID,{err:0,data:properties.data})}else{if(typeof global.hybridd.proc[properties.processID]!=="undefined"){global.hybridd.proc[properties.processID].data=properties.data}}return err}function insert(queueobject){var suffix=`0000${Math.random()*9999}`.slice(-4);var qid=Date.now()+suffix.toString();global.hybridd.APIqueue[qid]={cache:12e3,link:null,method:"POST",retry:3,retries:0,throttle:5,timeout:15e3,time:Date.now(),next:Date.now(),interval:2e3,host:null,reqcnt:0,pid:null,args:null,target:null};if(queueobject&&typeof queueobject==="object"){if(queueobject.hasOwnProperty("time")){delete queueobject.time}if(queueobject.hasOwnProperty("next")){delete queueobject.next}if(queueobject.hasOwnProperty("retries")){delete queueobject.retries}if(queueobject.hasOwnProperty("reqcnt")){delete queueobject.reqcnt}}Object.assign(global.hybridd.APIqueue[qid],queueobject);if(typeof global.hybridd.APIqueue[qid].host==="object"&&global.hybridd.APIqueue[qid].host.length){global.hybridd.APIqueue[qid].reqcnt=Math.floor(Math.random()*global.hybridd.APIqueue[qid].host.length)}return 1}
