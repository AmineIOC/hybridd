exports.main=main;var http=require("http");var fs=require("fs");var path=require("path");var recipesdirectory=path.normalize(`${process.cwd()}/../recipes/`);fs.readdir(recipesdirectory,function(err1,files){if(err1){console.log(` [!] warning: error when reading ${err1}`)}else{console.log(` [.] scanning recipes in ${recipesdirectory}`);files.sort().forEach(function(filename){if(fs.existsSync(path.join(recipesdirectory+filename))){entry=JSON.parse(fs.readFileSync(path.join(recipesdirectory+filename),"utf8"));if(typeof entry.symbol!=="undefined"){global.hybridd.asset[entry.symbol.toLowerCase()]=entry;console.log(` [i] found asset recipe ${filename}`)}if(typeof entry.id!=="undefined"){global.hybridd.source[entry.id.toLowerCase()]=entry;console.log(` [i] found source recipe ${filename}`)}}else{console.log(` [!] cannot load recipe ${filename}!`)}})}});var ini=require("./ini");Object.assign(global.hybridd,ini.parse(fs.readFileSync("../hybridd.conf","utf-8")));if(typeof global.hybridd.ignoreTLSerror!=="undefined"&&global.hybridd.ignoreTLSerror){process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"}last_xpath="";modules=require("./modules");scheduler=require("./scheduler");APIqueue=require("./APIqueue");function main(route){modules.init();function onRequest(request,response){request.sessionID=1;response.writeHead(200,{"Content-Type":"application/json"});response.write(route(request,modules));response.end()}http.createServer(onRequest).listen(global.hybridd.restport,global.hybridd.restbind);console.log(` [i] REST API running on: http://${global.hybridd.restbind}:${global.hybridd.restport}`);setTimeout(function(){scheduler.initialize();APIqueue.initialize()},1e3);if(typeof global.hybridd.userport!=="undefined"){function onUIRequest(request,response){if(request.url.indexOf("/api",0,4)==-1){if(request.url.indexOf("/favicon.ico",0,12)==-1){var index_html=fs.readFileSync("../views/index.html","utf8")}else{var index_html=fs.readFileSync("../views/favicon.ico")}response.writeHead(200,{"Content-Type":"text/html"});response.write(index_html);response.end()}else{request.sessionID=0;request.url=request.url.substring(4);response.writeHead(200,{"Content-Type":"application/json","Access-Control-Allow-Origin":"*"});response.write(route(request,modules));response.end()}}var userport=typeof global.hybridd.userport!=="undefined"?global.hybridd.userport:8080;http.createServer(onUIRequest).listen(userport,global.hybridd.userbind);console.log(` [i] user interface running on: http://${global.hybridd.userbind}:${global.hybridd.userport}`)}setInterval(function(){var maxentries=typeof global.hybridd.cacheidx!=="undefined"&&global.hybridd.cacheidx>0?global.hybridd.cacheidx:100;var cachedarray=Object.keys(cached);if(cachedarray.length>maxentries){for(var i=0;i<cachedarray.length-maxentries;i++){delete cached[cachedarray[i]]}}},1e3)}
