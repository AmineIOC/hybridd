var procpart=function procpart(processID){var procsplit=processID.split(".");var pieces={};var procinfo=[];procinfo[0]="";for(var i=0;i<procsplit.length-1;i+=1){pieces[i]=procsplit[i]}procinfo[0]=functions.implode(".",pieces);procinfo[1]=procsplit[procsplit.length-1];if(procinfo[1]-1>-1){procinfo[2]=procinfo[0]+"."+(procinfo[1]-1)}else{procinfo[2]=procinfo[0]}return procinfo};function func(p,module,funcname,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;if(DEBUG){console.log(" [D] ("+p.parentID+") function call to module "+module+" -> "+funcname)}if(typeof ydata!="object"){ydata={}}xdata.processID=p.processID;return new Function("modules.module."+module+".main."+funcname+"("+JSON.stringify(ydata)+");")()}function next(p,err,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;global.hybridd.proc[p.processID].err=typeof err==="undefined"?1:err;global.hybridd.proc[p.processID].busy=false;global.hybridd.proc[p.processID].progress=1;global.hybridd.proc[p.processID].stopped=Date.now();global.hybridd.proc[p.processID].data=ydata;return true}function dump(p,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;console.log("[D] ("+p.parentID+") dump: "+JSON.stringify(ydata));return next(p,0,ydata)}function wait(p,millisecs,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;if(DEBUG){console.log(" [D] ("+p.parentID+") waiting at "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}if(global.hybridd.proc[p.parentID].timeout>0&&millisecs<global.hybridd.proc[p.parentID].timeout&&global.hybridd.proc[p.parentID].timeout!=-1){global.hybridd.proc[p.parentID].timeout=global.hybridd.proc[p.parentID].timeout+millisecs}if(global.hybridd.proc[p.processID].timeout>0&&millisecs<global.hybridd.proc[p.processID].timeout&&global.hybridd.proc[p.processID].timeout!=-1){global.hybridd.proc[p.processID].timeout=global.hybridd.proc[p.processID].timeout+millisecs}return setTimeout(function(p,ydata){next(p,0,ydata)},millisecs,p,ydata)}function prwt(p,processID,millisecs){if(global.hybridd.proc[p.processID].sessionID===1||global.hybridd.proc[p.processID].sessionID===global.hybridd.proc[processID].sessionID){if(typeof global.hybridd.proc[processID]!="undefined"){if(global.hybridd.proc[processID].progress>=1||global.hybridd.proc[processID].stopped>1){next(p,global.hybridd.proc[processID].err,{processID:processID})}else{setTimeout(function(p,processID,millisecs){prwt(p,processID,millisecs)},millisecs||500,p,processID,millisecs||500)}if(DEBUG){console.log(" [D] ("+p.parentID+") processwait at "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}}return 1}else{stop(p,1,"prwt: insufficient permissions to access process "+processID+".")}}function coll(p,steps){if(DEBUG){console.log(" [D] ("+p.parentID+") collating subprocess data for "+steps+" steps")}if(typeof steps==="undefined"||steps===0){steps=global.hybridd.proc[p.parentID].step}if(steps>global.hybridd.proc[p.parentID].step){steps=global.hybridd.proc[p.parentID].step}var data=[];for(var i=global.hybridd.proc[p.parentID].step-steps;i<global.hybridd.proc[p.parentID].step;i+=1){data.push(global.hybridd.proc[p.parentID+"."+i].data)}return next(p,0,data)}function logs(p,level,log,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;console.log(" ["+(level==2?"!":level==1?"i":".")+"] "+log);return next(p,0,ydata)}function pass(p,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;if(DEBUG){console.log(" [D] ("+p.parentID+") passing subprocess data to parent process")}global.hybridd.proc[p.parentID].data=ydata;return next(p,0,ydata)}function jpar(p,xdata,failvalue){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;if(DEBUG){console.log(" [D] ("+p.parentID+") parsing string data to JSON object")}try{ydata=JSON.parse(ydata)}catch(e){if(typeof failvalue!=="undefined"){ydata=failvalue}else{data=null}}return next(p,0,ydata)}function prog(p,step,steps,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;if(DEBUG){console.log(" [D] ("+p.parentID+") progress reset to "+step+" of "+steps)}if(typeof steps==="undefined"){steps=1}if(step===-1){global.hybridd.proc[p.parentID].autoprog=true}else{global.hybridd.proc[p.parentID].progress=step/steps;global.hybridd.proc[p.parentID].autoprog=false}return next(p,0,ydata)}function time(p,millisecs,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;if(DEBUG){console.log(" [D] ("+p.parentID+") timeout for process forced to "+(millisecs?millisecs+"ms":"indefinite"))}var loopid;for(var i=global.hybridd.proc[p.parentID].step;i<=global.hybridd.proc[p.parentID].steps;i+=1){loopid=p.parentID+"."+i;if(global.hybridd.proc[loopid].timeout<millisecs||millisecs<=0){global.hybridd.proc[loopid].timeout=millisecs}}var parentID=true;var processID=p.processID;while(parentID){var procinfo=procpart(processID);if(procinfo[1]>-1){parentID=procinfo[0];processID=parentID}else{parentID=false}if(parentID){if(global.hybridd.proc[parentID].timeout<millisecs||millisecs<=0){global.hybridd.proc[parentID].timeout=millisecs}}}return next(p,0,ydata)}function stop(p,err,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;global.hybridd.proc[p.processID].busy=false;global.hybridd.proc[p.processID].err=typeof err==="undefined"?1:err;global.hybridd.proc[p.processID].progress=1;global.hybridd.proc[p.processID].stopped=Date.now();global.hybridd.proc[p.processID].data=ydata;global.hybridd.proc[p.parentID].busy=false;global.hybridd.proc[p.parentID].err=typeof err==="undefined"?1:err;global.hybridd.proc[p.parentID].progress=1;global.hybridd.proc[p.parentID].stopped=Date.now();global.hybridd.proc[p.parentID].data=ydata;if(DEBUG){console.log(" [D] ("+p.parentID+") stopped at step "+(global.hybridd.proc[p.parentID].step<=global.hybridd.proc[p.parentID].steps?global.hybridd.proc[p.parentID].step+1:1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}return 1}var jump=function(p,stepto,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;global.hybridd.proc[p.processID].started=Date.now();if(stepto===0||typeof stepto==="undefined"){stepto=1}if(stepto<0){var previd;for(var i=global.hybridd.proc[p.parentID].step+stepto;i<global.hybridd.proc[p.parentID].step;i+=1){previd=p.parentID+"."+i;global.hybridd.proc[previd].err=0;global.hybridd.proc[previd].busy=false;global.hybridd.proc[previd].progress=0;global.hybridd.proc[previd].started=Date.now();global.hybridd.proc[previd].stopped=null}}global.hybridd.proc[p.parentID].busy=false;global.hybridd.proc[p.parentID].step=global.hybridd.proc[p.parentID].step+stepto;global.hybridd.proc[p.processID].err=0;global.hybridd.proc[p.processID].busy=false;global.hybridd.proc[p.processID].progress=1;global.hybridd.proc[p.processID].data=ydata;if(DEBUG){console.log(" [D] ("+p.parentID+") jumping to step "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}global.hybridd.proc[p.processID].stopped=Date.now();return"step = step+"+stepto+";"};function test(p,condition,is_true,is_false,data){if(DEBUG){console.log(" [D] ("+p.parentID+") testing ["+condition+"] in step "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}if(condition){jump(p,is_true,data)}else if(typeof is_false==="undefined"){next(p,0,data)}else{jump(p,is_false,data)}return 1}function chckString(p,property,data){if(property.substr(0,1)!=="."){return{valid:true,data:property}}var propertyPath=property.substr(1).replace("]","").replace("[",".").split(".");var iterator=data;for(var i=0,len=propertyPath.length;i<len;++i){if(iterator!==null&&typeof iterator==="object"){if(iterator.constructor===Array){var index=Number(propertyPath[i]);if(index>=0&&index<iterator.length){iterator=iterator[index]}else{return{valid:false,data:data}}}else{if(iterator.hasOwnProperty(propertyPath[i])){iterator=iterator[propertyPath[i]]}else{return{valid:false,data:data}}}}else{return{valid:false,data:data}}}return{valid:true,data:iterator}}function chckVar(p,property,data){if(typeof property==="string"){return chckString(p,property,data)}else if(typeof property==="number"||typeof property==="boolean"||typeof property==="undefined"){return{valid:true,property:property}}else if(typeof property==="object"){if(property===null){return{valid:true,data:null}}else if(property.constructor===Array){var newData=[];for(var index,len=property.length;index<len;++index){var chckIndex=chckVar(p,property[index],data);if(!chckIndex.valid){return{valid:false,data:data}}newData[key]=chckIndex.data}return{valid:true,data:newData}}else{var newData={};for(var key in property){var chckKey=chckVar(p,property[key],data);if(!chckKey.valid){return{valid:false,data:data}}newData[key]=chckKey.data}return{valid:true,data:newData}}}}function tran(p,property,testObject,is_valid,is_invalid,xdata){if(DEBUG){console.log(" [D] ("+p.parentID+") tran ["+JSON.stringify(property)+"] in step "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}var checkVar=chckVar(p,property,testObject);if(checkVar.valid){jump(p,is_valid,xdata?xdata:checkVar.data)}else if(typeof is_invalid==="undefined"){next(p,0,typeof xdata!=="undefined"?xdata:testObject)}else{jump(p,is_invalid,typeof xdata!=="undefined"?xdata:testObject)}return 1}function find(p,findObject,searchArray,found,not_found,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;if(DEBUG){console.log(" [D] ("+p.parentID+") find ["+JSON.stringify(property)+"] in step "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}var matches=[],query;query=JSON.stringify(findObject).replace(new RegExp("^[{]*"),"").replace(new RegExp("[}]*$"),"");if(Object.prototype.toString.call(searchArray)!=="[object Array]"){searchArray=[].push(searchArray)}for(var i=0;i<searchArray.length;i++){if(JSON.stringify(searchArray[i]).indexOf(query)>-1){matches.push(searchArray[i])}}if(matches.length>0){jump(p,found,matches.length===1?matches[0]:matches)}else if(typeof not_found==="undefined"){next(p,0,ydata)}else{jump(p,not_found,ydata)}return 1}function form(p,xdata,factor,convert){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;if(DEBUG){console.log(" [D] ("+p.parentID+") form ["+JSON.stringify(ydata)+","+JSON.stringify(factor)+"] in step "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}var result=null;if(typeof convert==="undefined"||!convert||convert==="none"){result=padFloat(ydata,factor)}else if(convert===1||convert==="reduce"){result=padFloat(fromInt(ydata,factor),factor)}else if(convert===2||convert==="atomic"){result=toInt(ydata,factor).toInteger()}next(p,0,result)}function expl(p,seperator,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;var result=ydata.split(seperator);next(p,0,result)}function impl(p,seperator,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;var result=ydata.join(seperator);next(p,0,result)}function curl(p,target,querystring,method,xdata,headers,overwriteProperties){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;var properties;var link;if(target.substr(0,8)==="asset://"){target=target.substring(8,target.length);var base=target.split(".")[0];link='asset["'+base+'"]';properties={};Object.assign(properties,global.hybridd.asset[base]);if(base!==target){properties=Object.assign(properties,global.hybridd.asset[target])}}else if(target.substr(0,9)==="source://"){target=target.substring(7,target.length);var base=target.split(".")[0];link='source["'+base+'"]';properties={};Object.assign(properties,global.hybridd.source[base]);if(base!==target){properties=Object.assign(properties,global.hybridd.source[target])}}else{var targetSplitOnAdd=target.split("@");properties={};if(targetSplitOnAdd.length==1){properties.host=targetSplitOnAdd[0]}else{var protocolSplit=targetSplitOnAdd[0].split("/");var userSplitOnColon=protocolSplit[2].split(":");properties.user=userSplitOnColon[0];properties.pass=userSplitOnColon.length>1?userSplitOnColon[1]:undefined;properties.host=protocolSplit[0]+"//"+targetSplitOnAdd[1]}}var args={};args["data"]=ydata;args["path"]=querystring;if(properties.hasOwnProperty("rejectUnauthorized")&&!properties["rejectUnauthorized"]){console.log(" [!] module quartz: unauthorized TLS/SSL certificates ignored for "+properties.symbol);args["rejectUnauthorized"]=false}args.headers=headers;var queueObject={link:link,target:target,host:properties.host,user:properties.user,pass:properties.pass,args:args,method:method,retry:properties.retry,throttle:properties.throttle,timeout:properties.timeout,interval:properties.retry,pid:p.processID};var cleanQueueObject=Object.keys(queueObject).reduce(function(cleanQueueObject,key){if(typeof queueObject[key]!=="undefined"){cleanQueueObject[key]=queueObject[key]}return cleanQueueObject},{});if(overwriteProperties){if(overwriteProperties.hasOwnProperty("pid")){delete overwriteProperties.pid}if(overwriteProperties.hasOwnProperty("link")){delete overwriteProperties.link}Object.assign(cleanQueueObject,overwriteProperties)}APIqueue.add(cleanQueueObject)}function fork(p,target,xpath,xdata,childId){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;var requestPID=typeof childID==="undefined"?0:p.processID+"."+childId;var childPID=scheduler.init(requestPID,{data:ydata});var childRecipe;if(target.substr(0,8)==="asset://"){target=target.substring(8,target.length);childRecipe=global.hybridd.asset[target]}else if(target.substr(0,9)==="source://"){target=target.substring(7,target.length);childRecipe=global.hybridd.source[target]}else{stop(p,1,"call: target not found: '"+target+"'");return 0}modules.module[childRecipe.module].main.exec({processID:childPID,parentID:p.processID,target:childRecipe,mode:childRecipe.mode,factor:childRecipe.factor,command:xpath.split("/")});return childPID}function call(p,target,xpath,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;read(p,fork(p,target,xpath,ydata,0))}function read(p,processIDs,millisecs){var permission;if(typeof processIDs==="string"){permission=global.hybridd.proc[p.processID].sessionID===1||global.hybridd.proc[p.processID].sessionID===global.hybridd.proc[processIDs].sessionID}else if(processIDs instanceof Array){permission=processIDs.reduce(function(permission,processID){return permission&&global.hybridd.proc.hasOwnProperty(processID)&&(global.hybridd.proc[this.mainProcessID].sessionID===1||global.hybridd.proc[this.mainProcessID].sessionID===global.hybridd.proc[processID].sessionID)}.bind({mainProcessID:p.processID}),true)}else{permission=true;for(var key in processIDs){var processID=processIDs[key];if(!global.hybridd.proc.hasOwnProperty(processID)||global.hybridd.proc[p.processID].sessionID!==1&&global.hybridd.proc[p.processID].sessionID!==global.hybridd.proc[processID].sessionID){permission=false;break}}}if(permission){var finished;if(typeof processIDs==="string"){finished=global.hybridd.proc[processIDs].progress>=1||global.hybridd.proc[processIDs].stopped>1}else if(processIDs instanceof Array){finished=processIDs.reduce(function(finished,processID){return finished&&(global.hybridd.proc[processID].progress>=1||global.hybridd.proc[processID].stopped>1)},true)}else{for(var key in processIDs){var processID=processIDs[key];finished=true;if(global.hybridd.proc[processID].progress<1&&global.hybridd.proc[processID].stopped<=1){finished=false;break}}}if(finished){var result;if(typeof processIDs==="string"){result={data:global.hybridd.proc[processIDs].data,err:global.hybridd.proc[processIDs].err}}else if(processIDs instanceof Array){result=processIDs.reduce(function(result,processID){return{data:result.data.concat([global.hybridd.proc[processID].data]),err:Math.max(result.err,global.hybridd.proc[processID].err)}},{data:[],err:0})}else{result={data:{},err:0};for(var key in processIDs){var processID=processIDs[key];result.data[key]=global.hybridd.proc[processID].data;result.err=Math.max(global.hybridd.proc[processID].err,result.err)}}next(p,result.err,result.data)}else{setTimeout(function(p,processIDs,millisecs){read(p,processIDs,millisecs)},millisecs||500,p,processIDs,millisecs||500)}}else{stop(p,1,"read: insufficient permissions to access processes "+processIDs+".")}}function each(p,container,target,xpath,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;var processIDs;if(container instanceof Array){processIDs=[];for(var key=0;key<container.length;++key){processIDs.push(fork(p,target,xpath,{data:ydata,container:container,key:key,value:container[key]},key))}}else{processIDs={};var index=0;for(var key in container){processIDs[key]=fork(p,target,xpath,{data:ydata,container:container,key:key,value:container[key]},index);++index}}read(p,processIDs)}function poke(p,variable,pokedata,xdata){var ydata=typeof xdata==="undefined"?global.hybridd.proc[p.processID].data:xdata;if(DEBUG){console.log(" [D] ("+p.parentID+") poke ["+JSON.stringify(variable)+"] in step "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}var rootID=p.processID.substring(0,p.processID.indexOf("."));global.hybridd.proc[rootID].vars[variable]=pokedata;next(p,0,ydata);return 1}var peek=function(p,variable){if(DEBUG){console.log(" [D] ("+p.parentID+") peek ["+JSON.stringify(variable)+"] in step "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}var rootID=p.processID.substring(0,p.processID.indexOf("."));var pdata=null;if(typeof global.hybridd.proc[rootID].vars!="undefined"){if(typeof global.hybridd.proc[rootID].vars[variable]!="undefined"){pdata=global.hybridd.proc[rootID].vars[variable]}}return pdata};
