functions=require("./functions");exports.initialize=initialize;exports.init=initproc;exports.stop=stopproc;exports.fire=subqueue;exports.procpart=procpart;function initialize(){setInterval(function(){var processID;for(processID in global.hybridd.procqueue){if(DEBUG){console.log(" [D] processing engine creating process "+processID)}seqproc(processID,global.hybridd.procqueue[processID]);delete global.hybridd.procqueue[processID]}},50);setInterval(function(){var procpurgetime=600;var processID;var parentID;for(processID in global.hybridd.proc){var procinfo=procpart(processID);if(procinfo[1]>-1){parentID=procinfo[0]}else{parentID=false}var proctimeout=global.hybridd.proc[processID].timeout!=null?global.hybridd.proc[processID].timeout:15e3;if(typeof global.hybridd.proc[processID]!="undefined"){if(proctimeout>0&&global.hybridd.proc[processID].started<Date.now()-procpurgetime*1e3){if(DEBUG){console.log(" [D] processing engine purging process "+processID)}delete global.hybridd.proc[processID]}else{if(proctimeout>0&&(global.hybridd.proc[processID].stopped==null&&global.hybridd.proc[processID].started<Date.now()-proctimeout)){if(DEBUG){console.log(" [D] process "+processID+" has timed out")}global.hybridd.proc[processID].err=1;global.hybridd.proc[processID].info="Process timeout!";global.hybridd.proc[processID].busy=false;global.hybridd.proc[processID].stopped=Date.now()}}}}},1e3)}function subqueue(processID,subprocesses){result=true;if(typeof subprocesses!="undefined"){if(subprocesses.length>-1){if(DEBUG){console.log(" [D] adding "+processID+" to processing queue")}initproc(processID,{subprocesses:subprocesses});result=false}}return result}function initproc(processID,properties){if(typeof properties!="undefined"){if(typeof properties.subprocesses!="undefined"){global.hybridd.procqueue[processID]=properties.subprocesses}}if(processID==0){var suffix=("000"+Math.random()*999).slice(-3);processID=Date.now()+suffix.toString()}global.hybridd.proc[processID]={};global.hybridd.proc[processID].err=0;global.hybridd.proc[processID].busy=null;global.hybridd.proc[processID].step=null;global.hybridd.proc[processID].steps=null;global.hybridd.proc[processID].subproc=null;global.hybridd.proc[processID].progress=0;global.hybridd.proc[processID].autoprog=true;global.hybridd.proc[processID].timeout=null;global.hybridd.proc[processID].started=Date.now();global.hybridd.proc[processID].stopped=null;global.hybridd.proc[processID].request=null;global.hybridd.proc[processID].data=null;if(processID.indexOf(".")==-1){global.hybridd.proc[processID].vars={}}return processID}function stopproc(processID,properties){if(typeof properties=="undefined"){properties={}}try{if(global.hybridd.proc[processID].stopped==null){global.hybridd.proc[processID].err=typeof properties.err!="undefined"?properties.err:0;global.hybridd.proc[processID].data=typeof properties.data!="undefined"?properties.data:null;global.hybridd.proc[processID].progress=1;global.hybridd.proc[processID].stopped=Date.now()}else{if(DEBUG){console.log(" [D] ("+processID+") process was already stopped")}console.log(" [D] warning: process "+processID+" was already stopped")}}catch(e){if(DEBUG){console.log(" [D] process "+processID+" no longer exists, or cannot be stopped")}}}function procpart(processID){var procsplit=processID.split(".");var pieces={};var procinfo=[];procinfo[0]="";var i;for(i=0;i<procsplit.length-1;i++){pieces[i]=procsplit[i]}procinfo[0]=functions.implode(".",pieces);procinfo[1]=procsplit[procsplit.length-1];if(procinfo[1]-1>-1){procinfo[2]=procinfo[0]+"."+(procinfo[1]-1)}else{procinfo[2]=procinfo[0]}return procinfo}function seqproc(processID,subprocesses){var step=0;var subprocess=null;global.hybridd.proc[processID].step=0;global.hybridd.proc[processID].steps=subprocesses.length-1;global.hybridd.proc[processID].busy=false;if(DEBUG){console.log(" [D] ("+processID+") initializing sequence processing for "+(global.hybridd.proc[processID].steps+1)+" steps...")}for(step=0;step<subprocesses.length;++step){initproc(processID+"."+step);subprocesses[step]=subprocesses[step].replace('"processID":"'+processID+'"','"processID":"'+processID+"."+step+'"');global.hybridd.proc[processID+"."+step].request=subprocesses[step]}seqstep(processID,subprocesses,0)}function seqstep(processID,subprocesses,step){var runprocess=subprocesses[step];if(global.hybridd.proc[processID].busy==true){if(global.hybridd.proc[processID+"."+step].progress==1){if(DEBUG){console.log(" [D] ("+processID+") finished step "+(step+1)+" of "+(global.hybridd.proc[processID].steps+1))}if(global.hybridd.proc[processID].autoprog==true){global.hybridd.proc[processID].progress=global.hybridd.proc[processID].step/global.hybridd.proc[processID].steps}global.hybridd.proc[processID].busy=false;if(global.hybridd.proc[processID].progress==1){global.hybridd.proc[processID].stopped=Date.now()}else{global.hybridd.proc[processID].step++}if(step==global.hybridd.proc[processID].steps){var prevID=global.hybridd.proc[processID].subproc;if(typeof global.hybridd.proc[prevID]!="undefined"){var err=typeof global.hybridd.proc[prevID].err!="undefined"?global.hybridd.proc[prevID].err:1;var data=typeof global.hybridd.proc[prevID].data!="undefined"?global.hybridd.proc[prevID].data:null}else{var err=null;var data=null}var p={parentID:processID,processID:processID+"."+step};stop(p,err,data)}}else{if(global.hybridd.proc[processID].autoprog==true){if(global.hybridd.proc[processID+"."+step].steps>0){global.hybridd.proc[processID].progress=(global.hybridd.proc[processID].step-1)/global.hybridd.proc[processID].steps+1/global.hybridd.proc[processID].steps*global.hybridd.proc[processID+"."+step].progress}}}setTimeout(function(){if(typeof global.hybridd.proc[processID]!="undefined"){if(typeof global.hybridd.proc[processID].step!="undefined"){seqstep(processID,subprocesses,global.hybridd.proc[processID].step)}}},200)}else if(global.hybridd.proc[processID].busy!=true&&global.hybridd.proc[processID].stopped==null&&global.hybridd.proc[processID].step<=global.hybridd.proc[processID].steps){global.hybridd.proc[processID].busy=true;if(DEBUG){console.log(" [D] ("+processID+") running step "+(step+1)+" of "+(global.hybridd.proc[processID].steps+1))}var prevID=global.hybridd.proc[processID].subproc;if(typeof global.hybridd.proc[prevID]!="undefined"){var err=typeof global.hybridd.proc[prevID].err!="undefined"?global.hybridd.proc[prevID].err:1;var data=typeof global.hybridd.proc[prevID].data!="undefined"?global.hybridd.proc[prevID].data:null}else{var err=null;var data=null}var subinsert='{parentID:"'+processID+'",processID:"'+processID+"."+step+'"}';runprocess=subprocesses[step].replace(/peek\(/g,"peek("+subinsert+",");if(["next","dump","logs","func","time","wait","prwt","stop","jump","test","poke","prog","pass","push","coll"].indexOf(subprocesses[step].substr(0,4))>-1){runprocess=runprocess.slice(0,5)+subinsert+","+runprocess.slice(5)}global.hybridd.proc[processID].subproc=processID+"."+step;try{{{{eval(runprocess)}}}}catch(e){console.log(" [!] ("+processID+") proc error: "+"\n     "+runprocess+"\n     "+(e?e:"UNKNOWN ERROR!"))}setTimeout(function(){seqstep(processID,subprocesses,global.hybridd.proc[processID].step)},200)}}function func(p,module,funcname,funcdata,data){if(DEBUG){console.log(" [D] ("+p.parentID+") function call to module "+module+" -> "+funcname)}if(typeof funcdata!="object"){funcdata={}}funcdata.processID=p.processID;try{eval("modules.module."+module+".main."+funcname+"("+JSON.stringify(funcdata)+");")}catch(e){if(DEBUG){console.log(" [D] ("+p.parentID+") error in call (module "+module+" -> "+funcname+")"+(e?" | "+e:""))}next(p,1,"[func "+module+","+funcname+"]")}}function next(p,err,data){global.hybridd.proc[p.processID].err=typeof err=="undefined"?1:err;global.hybridd.proc[p.processID].busy=false;global.hybridd.proc[p.processID].progress=1;global.hybridd.proc[p.processID].stopped=Date.now();global.hybridd.proc[p.processID].data=typeof data!="undefined"?data:"[next]";return true}function dump(p,data){console.log("[D] ("+p.parentID+") dump: "+JSON.stringify(data));next(p,0,data)}function wait(p,millisecs,data){if(DEBUG){console.log(" [D] ("+p.parentID+") waiting at "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}if(typeof data=="undefined"){data="[wait "+millisecs+"]"}if(global.hybridd.proc[p.parentID].timeout>0&&millisecs<global.hybridd.proc[p.parentID].timeout&&global.hybridd.proc[p.parentID].timeout!=-1){global.hybridd.proc[p.parentID].timeout=global.hybridd.proc[p.parentID].timeout+millisecs}if(global.hybridd.proc[p.processID].timeout>0&&millisecs<global.hybridd.proc[p.processID].timeout&&global.hybridd.proc[p.processID].timeout!=-1){global.hybridd.proc[p.processID].timeout=global.hybridd.proc[p.processID].timeout+millisecs}setTimeout(function(p,data){next(p,0,data)},millisecs,p,data)}function prwt(p,processID){var millisecs=500;if(typeof global.hybridd.proc[processID]!="undefined"){if(global.hybridd.proc[processID].progress>=1||global.hybridd.proc[processID].stopped>1){next(p,global.hybridd.proc[processID].err,{processID:processID})}else{setTimeout(function(p,processID){prwt(p,processID)},millisecs,p,processID)}if(DEBUG){console.log(" [D] ("+p.parentID+") processwait at "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}}}function coll(p,steps){if(DEBUG){console.log(" [D] ("+p.parentID+") collating subprocess data for "+steps+" steps")}if(typeof steps=="undefined"||steps==0){steps=global.hybridd.proc[p.parentID].step}if(steps>global.hybridd.proc[p.parentID].step){steps=global.hybridd.proc[p.parentID].step}var data=[];for(var i=global.hybridd.proc[p.parentID].step-steps;i<global.hybridd.proc[p.parentID].step;i++){data.push(global.hybridd.proc[p.parentID+"."+i].data)}next(p,0,data)}function logs(p,level,log,data){console.log(" ["+(level==2?"!":level==1?"i":".")+"] "+log);if(typeof data=="undefined"){data="[logs]"}next(p,0,data)}function pass(p,data){if(DEBUG){console.log(" [D] ("+p.parentID+") passing subprocess data to parent process")}if(typeof data=="undefined"){data="[pass]"}global.hybridd.proc[p.parentID].data=data;next(p,0,data)}function push(p,data){pass(p,0,data)}function prog(p,step,steps,data){if(DEBUG){console.log(" [D] ("+p.parentID+") progress reset to "+step+" of "+steps)}if(typeof steps=="undefined"){steps=1}if(typeof data=="undefined"){data="[prog "+step+"/"+steps+"]"}if(step==-1){global.hybridd.proc[p.parentID].autoprog=true}else{global.hybridd.proc[p.parentID].progress=step/steps;global.hybridd.proc[p.parentID].autoprog=false}next(p,0,data)}function time(p,millisecs,data){if(DEBUG){console.log(" [D] ("+p.parentID+") timeout for process forced to "+(millisecs?millisecs+"ms":"indefinite"))}if(typeof data=="undefined"){data="[time "+millisecs+"]"}var loopid;for(var i=global.hybridd.proc[p.parentID].step;i<=global.hybridd.proc[p.parentID].steps;i++){loopid=p.parentID+"."+i;if(global.hybridd.proc[loopid].timeout<millisecs||millisecs<=0){global.hybridd.proc[loopid].timeout=millisecs}}var parentID=true;var processID=p.processID;while(parentID){var procinfo=procpart(processID);if(procinfo[1]>-1){parentID=procinfo[0];processID=parentID}else{parentID=false}if(parentID){if(global.hybridd.proc[parentID].timeout<millisecs||millisecs<=0){global.hybridd.proc[parentID].timeout=millisecs}}}next(p,0,data)}function stop(p,err,data){global.hybridd.proc[p.parentID].busy=false;global.hybridd.proc[p.parentID].err=typeof err=="undefined"?1:err;global.hybridd.proc[p.parentID].progress=1;global.hybridd.proc[p.parentID].stopped=Date.now();global.hybridd.proc[p.parentID].data=typeof data!="undefined"?data:"[stop]";global.hybridd.proc[p.processID].busy=false;global.hybridd.proc[p.processID].err=typeof err=="undefined"?1:err;global.hybridd.proc[p.processID].progress=1;global.hybridd.proc[p.processID].stopped=Date.now();global.hybridd.proc[p.processID].data=typeof data!="undefined"?data:"[stop]";if(DEBUG){console.log(" [D] ("+p.parentID+") stopped at step "+(global.hybridd.proc[p.parentID].step<=global.hybridd.proc[p.parentID].steps?global.hybridd.proc[p.parentID].step+1:1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}}jump=function(p,stepto,data){if(typeof data=="undefined"){data="[jump "+stepto+"]"}global.hybridd.proc[p.processID].started=Date.now();if(stepto==0){stepto=1}if(stepto<0){var previd;for(var i=global.hybridd.proc[p.parentID].step+stepto;i<global.hybridd.proc[p.parentID].step;i++){previd=p.parentID+"."+i;global.hybridd.proc[previd].err=0;global.hybridd.proc[previd].busy=false;global.hybridd.proc[previd].progress=0;global.hybridd.proc[previd].started=Date.now();global.hybridd.proc[previd].stopped=null}}global.hybridd.proc[p.parentID].busy=false;global.hybridd.proc[p.parentID].step=global.hybridd.proc[p.parentID].step+stepto;global.hybridd.proc[p.processID].err=0;global.hybridd.proc[p.processID].busy=false;global.hybridd.proc[p.processID].progress=1;global.hybridd.proc[p.processID].data=data;if(DEBUG){console.log(" [D] ("+p.parentID+") jumping to step "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}global.hybridd.proc[p.processID].stopped=Date.now();return"step = step+"+stepto+";"};function test(p,condition,is_true,is_false,data){if(DEBUG){console.log(" [D] ("+p.parentID+") testing ["+condition+"] in step "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}{{{var result=eval(condition)}}}if(result){if(typeof data=="undefined"){data="[test T "+is_true+"]"}jump(p,is_true,data)}else{if(typeof is_false=="undefined"){if(typeof data=="undefined"){data="[test F 1]"}next(p,0,data)}else{if(typeof data=="undefined"){data="[test F "+is_false+"]"}jump(p,is_false,data)}}return true}function poke(p,variable,pokedata,data){if(typeof data=="undefined"){data="[poke]"}if(DEBUG){console.log(" [D] ("+p.parentID+") poke ["+JSON.stringify(variable)+"] in step "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}var rootID=p.processID.substring(0,p.processID.indexOf("."));global.hybridd.proc[rootID].vars[variable]=pokedata;next(p,0,data);return true}json=function(p,str){if(DEBUG){console.log(" [D] ("+p.parentID+") json ["+JSON.stringify(str)+"] in step "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}if(str==="")str="{}";eval("{{{ var p="+str+";;; }}}");return p};peek=function(p,variable){if(DEBUG){console.log(" [D] ("+p.parentID+") peek ["+JSON.stringify(variable)+"] in step "+(global.hybridd.proc[p.parentID].step+1)+" of "+(global.hybridd.proc[p.parentID].steps+1))}var rootID=p.processID.substring(0,p.processID.indexOf("."));var data=null;if(typeof global.hybridd.proc[rootID].vars!="undefined"){if(typeof global.hybridd.proc[rootID].vars[variable]!="undefined"){data=global.hybridd.proc[rootID].vars[variable]}}return data};
