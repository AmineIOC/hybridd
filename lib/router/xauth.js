var route=require("../router");var functions=require("../functions");var LZString=require("../crypto/lz-string");var UrlBase64=require("../crypto/urlbase64");exports.processX=processX;exports.processY=processY;exports.processZ=processZ;function processX(request,xpath){if(xpath.length>1){var tmp=xauth(request,xpath);return tmp}else{return""}}function processY(request,xpath){if(xpath.length===4){try{request.url=xplain(xpath[1],xpath[2],UrlBase64.safeDecompress(xpath[3]));request.sessionID=xpath[1];request.nonce=xpath[2];return UrlBase64.safeCompress(xcrypt(xpath[1],xpath[2],route.route(request,modules)))}catch(err){return""}}else{return""}}function processZ(request,xpath){if(xpath.length===4){try{request.url=LZString.decompressFromEncodedURIComponent(xplain(xpath[1],xpath[2],UrlBase64.safeDecompress(xpath[3])));request.sessionID=xpath[1];request.nonce=xpath[2];return UrlBase64.safeCompress(xcrypt(xpath[1],xpath[2],LZString.compressToEncodedURIComponent(route.route(request,modules))))}catch(err){return""}}else{return""}}function xauth(http_req,xpath){var xresponse={error:1};var session_step=parseInt(xpath[2]);if(session_step<2){try{var session_hexkey=String(functions.clean(xpath[1]));if(typeof global.hybridd.xauth.session[session_hexkey]==="undefined"&&session_step===0&&session_hexkey.length===64){var nonce1=nacl.to_hex(nacl.crypto_box_random_nonce()).replace(/^[8-9a-f]/,function(match){var range=["8","9","a","b","c","d","e","f"];return range.indexOf(match)});global.hybridd.xauth.session[session_hexkey]={nonce1:nonce1};xresponse={error:0,nonce1:global.hybridd.xauth.session[session_hexkey].nonce1}}else if(typeof global.hybridd.xauth.session[session_hexkey].nonce1!=="undefined"&&session_step===1){var crypt_bin=nacl.from_hex(functions.clean(xpath[3]));var session_binkey=nacl.from_hex(session_hexkey);var crypt_msg=nacl.crypto_sign_open(crypt_bin,session_binkey);if(crypt_msg){var secrets_json=JSON.parse(nacl.decode_utf8(crypt_msg));if(DEBUG){console.log(JSON.stringify(secrets_json))}if(secrets_json.nonce1===global.hybridd.xauth.session[session_hexkey].nonce1){global.hybridd.xauth.session[session_hexkey].nonce2=functions.clean(secrets_json.nonce2);var server_session_seed=nacl.random_bytes(4096);var server_session_keypair=nacl.crypto_box_keypair_from_seed(server_session_seed);global.hybridd.xauth.session[session_hexkey].server_session_seckey=nacl.to_hex(server_session_keypair.boxSk);var server_session_pubkey=nacl.to_hex(server_session_keypair.boxPk);global.hybridd.xauth.session[session_hexkey].client_session_pubkey=secrets_json.client_session_pubkey;var server_session_signpair=nacl.crypto_sign_keypair_from_seed(nacl.crypto_hash_sha256(server_session_seed));global.hybridd.xauth.session[session_hexkey].server_sign_seckey=nacl.to_hex(server_session_signpair.signSk);var server_sign_pubkey=nacl.to_hex(server_session_signpair.signPk);var nonce1_dec=new Decimal(hex2dec.toDec(global.hybridd.xauth.session[session_hexkey].nonce1));var nonce2_dec=new Decimal(hex2dec.toDec(global.hybridd.xauth.session[session_hexkey].nonce2));var step_dec=new Decimal(session_step);var nonce_constr=nonce1_dec.plus(nonce2_dec).plus(step_dec);var nonce_convert=hex2dec.toHex(nonce_constr.toFixed(0).toString());var nonce_conhex=nonce_convert.substr(2,nonce_convert.length);var current_nonce=nacl.from_hex(nonce_conhex);var session_secrets={server_sign_pubkey:server_sign_pubkey,server_session_pubkey:server_session_pubkey,current_nonce:nonce_conhex};if(DEBUG){console.log("Server side xcrypt nonce: "+nonce_conhex+" CryptPacket data: "+JSON.stringify(session_secrets))}var crypt_bin=nacl.encode_utf8(JSON.stringify(session_secrets));if(DEBUG){console.log("Server side utf-8"+crypt_bin)}var sign_hex=nacl.to_hex(nacl.crypto_sign(crypt_bin,server_session_signpair.signSk));if(DEBUG){console.log("Server side sign_hex"+sign_hex)}var client_session_pubkey=global.hybridd.xauth.session[session_hexkey].client_session_pubkey;var server_session_seckey=global.hybridd.xauth.session[session_hexkey].server_session_seckey;var sign_bin=nacl.from_hex(sign_hex);var client_session_pubkey_bin=nacl.from_hex(client_session_pubkey);var server_session_seckey_bin=nacl.from_hex(server_session_seckey);var crypt_hex=nacl.to_hex(nacl.crypto_box(sign_bin,current_nonce,client_session_pubkey_bin,server_session_seckey_bin));if(DEBUG){console.log("Server side crypt_hex"+crypt_hex)}xresponse={error:0,server_sign_pubkey:server_sign_pubkey,server_session_pubkey:server_session_pubkey,current_nonce:nonce_conhex,crhex:crypt_hex};if(DEBUG){console.log("xresponse:"+JSON.stringify(xresponse))}}}}else{if(typeof global.hybridd.xauth.session[session_hexkey]!=="undefined"){delete global.hybridd.xauth.session[session_hexkey]}}}catch(err){}}return xresponse}function xcrypt(session_hexkey,session_step,txtdata){if(typeof global.hybridd.xauth.session[session_hexkey].server_session_seckey!=="undefined"&&!global.hybridd.xauth.session[session_hexkey].invalid){var server_sign_pubkey=global.hybridd.xauth.session[session_hexkey].server_session_pubsign;var client_session_pubkey=nacl.from_hex(global.hybridd.xauth.session[session_hexkey].client_session_pubkey);var server_session_seckey=nacl.from_hex(global.hybridd.xauth.session[session_hexkey].server_session_seckey);var nonce1_dec=new Decimal(hex2dec.toDec(global.hybridd.xauth.session[session_hexkey].nonce1));var nonce2_dec=new Decimal(hex2dec.toDec(global.hybridd.xauth.session[session_hexkey].nonce2));var step_dec=new Decimal(session_step);var nonce_constr=nonce1_dec.plus(nonce2_dec).plus(step_dec);var nonce_convert=hex2dec.toHex(nonce_constr.toFixed(0).toString());var nonce_conhex=nonce_convert.substr(2,nonce_convert.length);var session_nonce=nacl.from_hex(nonce_conhex);var crypt_utf8=nacl.encode_utf8(txtdata);var crypt_hex=nacl.to_hex(nacl.crypto_box(crypt_utf8,session_nonce,client_session_pubkey,server_session_seckey));return crypt_hex}else{if(typeof global.hybridd.xauth.session[session_hexkey]!=="undefined"){delete global.hybridd.xauth.session[session_hexkey]}return null}}function xplain(session_hexkey,session_step,encdata){if(!global.hybridd.xauth.session[session_hexkey].invalid){if(typeof global.hybridd.xauth.session[session_hexkey].server_session_seckey!=="undefined"&&typeof encdata!=="undefined"&&encdata){var crypt_bin=nacl.from_hex(functions.clean(encdata));var client_session_pubkey=nacl.from_hex(global.hybridd.xauth.session[session_hexkey].client_session_pubkey);var server_session_seckey=nacl.from_hex(global.hybridd.xauth.session[session_hexkey].server_session_seckey);var nonce1_dec=new Decimal(hex2dec.toDec(global.hybridd.xauth.session[session_hexkey].nonce1));var nonce2_dec=new Decimal(hex2dec.toDec(global.hybridd.xauth.session[session_hexkey].nonce2));var step_dec=new Decimal(session_step);var nonce_constr=nonce1_dec.plus(nonce2_dec).plus(step_dec);var nonce_convert=hex2dec.toHex(nonce_constr.toFixed(0).toString());var session_nonce=nacl.from_hex(nonce_convert.substr(2,nonce_convert.length));var payload=nacl.decode_utf8(nacl.crypto_box_open(crypt_bin,session_nonce,client_session_pubkey,server_session_seckey))}else{global.hybridd.xauth.session[session_hexkey].invalid=1;payload=null}return payload}else{if(typeof global.hybridd.xauth.session[session_hexkey]!=="undefined"){delete global.hybridd.xauth.session[session_hexkey]}return null}}
