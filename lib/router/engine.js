var cache=require("../cache");var enginelist=function enginelist(module){var enginecnt=0;var engine=[];for(var key in global.hybridd.engine){if(typeof global.hybridd.engine[key].engine!=="undefined"){engine.push(global.hybridd.engine[key].engine);enginecnt+=1}}return{error:0,info:"List of available engine's.",id:"engine"+(typeof module!=="undefined"?"/"+module:""),count:enginecnt,data:engine.sort()}};var directcommand=function directcommand(target,lxpath,sessionID){if(lxpath[3]){var processID=scheduler.init(0,{sessionID:sessionID});var cnta=1;var cntb=4;var command=[];command[0]=lxpath[3];while(typeof lxpath[cntb]!=="undefined"){command[cnta]=lxpath[cntb];cnta+=1;cntb+=1}if(typeof modules.module[target.module]==="undefined"){console.log(` [!] module ${target.module}: not loaded, or disfunctional!`);var result={error:1,info:"Module not found or dysfunctional!"}}else{modules.module[target.module].main.link({command:command,processID:processID,target:target});result={data:processID,error:0,id:"id",info:"Command process ID.",request:command}}}else{result={error:1,info:`You must give a command! (Example: http://${global.hybridd.restbind}:${global.hybridd.restport}/engine/blockexplorer/command/help)`}}return result};var engineexec=function engineexec(target,lxpath,sessionID){var processID=scheduler.init(0,{sessionID:sessionID});var cnta=1;var cntb=3;var command=[];command[0]=lxpath[2];while(typeof lxpath[cntb]!=="undefined"){command[cnta]=lxpath[cntb];cnta+=1;cntb+=1}if(typeof global.hybridd.engine[target.id]==="undefined"||typeof modules.module[global.hybridd.engine[target.id].module]==="undefined"){console.log(` [!] module ${module}: not loaded, or disfunctional!`);var result={error:1,info:"Module not found or disfunctional!"}}else{modules.module[global.hybridd.engine[target.id].module].main.exec({command:command,processID:processID,target:target});result={data:processID,error:0,id:"id",info:"Command process ID.",request:command}}return result};var process=function process(request,xpath){var result=null;var target={};if(xpath.length===1){result=enginelist()}else{var pathsengineExec=[];var command=null;switch(xpath[1]){case"storage":command=xpath[2];pathsengineExec=["get","set","del","pow","meta"];target={id:"storage",module:"storage"};break;default:break}if(["storage"].indexOf(xpath[1])>-1||typeof target!=="undefined"){if(xpath[2]==="command"&&request.sessionID===1){result=directcommand(target,xpath,request.sessionID)}else if(pathsengineExec.indexOf(command)>-1){var cacheVal=typeof target.cache!=="undefined"?target.cache:12e3;var cacheIdx=DJB2.hash(request.sessionID+xpath.join("/"));var cacheResult=cache.get(cacheIdx,cacheVal);if(!cacheResult){result=engineexec(target,xpath,request.sessionID);if(!result.error){cache.add(cacheIdx,result)}}else if(cacheResult.fresh){result=cacheResult.data}else{result=engineexec(target,xpath,request.sessionID);if(!result.error){cache.add(cacheIdx,result)}else{result=cacheResult.data}}}else{result={error:0,id:`engine/${xpath[1]}`,info:"Please use an engine function!",data:pathsengineExec}}}else{result={error:1,id:`engine/${xpath[1]}`,info:"engine not found!"}}}return result};exports.process=process;
