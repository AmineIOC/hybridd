exports.xauth=xauth;exports.xcrypt=xcrypt;exports.xplain=xplain;function xauth(http_req,xpath){var xresponse={error:1};var session_step=parseInt(xpath[2]);if(session_step<2){try{var session_hexkey=String(functions.clean(xpath[1]));if(typeof global.hybridd.xauth.session[session_hexkey]==="undefined"&&session_step===0&&session_hexkey.length===64){var nonce1=nacl.to_hex(nacl.crypto_box_random_nonce()).replace(/^[8-9a-f]/,function(match){var range=["8","9","a","b","c","d","e","f"];return range.indexOf(match)});global.hybridd.xauth.session[session_hexkey]={nonce1:nonce1};xresponse={error:0,nonce1:global.hybridd.xauth.session[session_hexkey].nonce1}}else if(typeof global.hybridd.xauth.session[session_hexkey].nonce1!=="undefined"&&session_step===1){var crypt_bin=nacl.from_hex(functions.clean(xpath[3]));var session_binkey=nacl.from_hex(session_hexkey);var crypt_msg=nacl.crypto_sign_open(crypt_bin,session_binkey);if(crypt_msg){var secrets_json=JSON.parse(nacl.decode_utf8(crypt_msg));if(secrets_json.nonce1===global.hybridd.xauth.session[session_hexkey].nonce1){global.hybridd.xauth.session[session_hexkey].nonce2=functions.clean(secrets_json.nonce2);var server_session_seed=nacl.random_bytes(4096);var server_session_keypair=nacl.crypto_box_keypair_from_seed(server_session_seed);global.hybridd.xauth.session[session_hexkey].server_session_seckey=nacl.to_hex(server_session_keypair.boxSk);var server_session_pubkey=nacl.to_hex(server_session_keypair.boxPk);global.hybridd.xauth.session[session_hexkey].client_session_pubkey=secrets_json.client_session_pubkey;var server_session_signpair=nacl.crypto_sign_keypair_from_seed(nacl.crypto_hash_sha256(server_session_seed));global.hybridd.xauth.session[session_hexkey].server_sign_seckey=nacl.to_hex(server_session_signpair.signSk);var server_sign_pubkey=nacl.to_hex(server_session_signpair.signPk);var session_secrets={server_sign_pubkey:server_sign_pubkey,server_session_pubkey:server_session_pubkey};var crypt_bin=nacl.encode_utf8(JSON.stringify(session_secrets));var crypt_hex=nacl.to_hex(nacl.crypto_sign(crypt_bin,server_session_signpair.signSk));xresponse={error:0,server_sign_pubkey:server_sign_pubkey,crhex:crypt_hex}}}}else{if(typeof global.hybridd.xauth.session[session_hexkey]!=="undefined"){delete global.hybridd.xauth.session[session_hexkey]}}}catch(err){}}return xresponse}function xcrypt(session_hexkey,session_step,txtdata){if(typeof global.hybridd.xauth.session[session_hexkey].server_session_seckey!=="undefined"&&!global.hybridd.xauth.session[session_hexkey].invalid){var server_sign_pubkey=global.hybridd.xauth.session[session_hexkey].server_session_pubsign;var client_session_pubkey=nacl.from_hex(global.hybridd.xauth.session[session_hexkey].client_session_pubkey);var server_session_seckey=nacl.from_hex(global.hybridd.xauth.session[session_hexkey].server_session_seckey);var nonce1_dec=new Decimal(hex2dec.toDec(global.hybridd.xauth.session[session_hexkey].nonce1));var nonce2_dec=new Decimal(hex2dec.toDec(global.hybridd.xauth.session[session_hexkey].nonce2));var step_dec=new Decimal(session_step);var nonce_constr=nonce1_dec.plus(nonce2_dec).plus(step_dec);var nonce_convert=hex2dec.toHex(nonce_constr.toFixed(0).toString());var nonce_conhex=nonce_convert.substr(2,nonce_convert.length);var session_nonce=nacl.from_hex(nonce_conhex);var crypt_utf8=nacl.encode_utf8(txtdata);var crypt_hex=nacl.to_hex(nacl.crypto_box(crypt_utf8,session_nonce,client_session_pubkey,server_session_seckey));return crypt_hex}else{if(typeof global.hybridd.xauth.session[session_hexkey]!=="undefined"){delete global.hybridd.xauth.session[session_hexkey]}return null}}function xplain(session_hexkey,session_step,encdata){if(!global.hybridd.xauth.session[session_hexkey].invalid){if(typeof global.hybridd.xauth.session[session_hexkey].server_session_seckey!=="undefined"&&typeof encdata!=="undefined"&&encdata){var crypt_bin=nacl.from_hex(functions.clean(encdata));var client_session_pubkey=nacl.from_hex(global.hybridd.xauth.session[session_hexkey].client_session_pubkey);var server_session_seckey=nacl.from_hex(global.hybridd.xauth.session[session_hexkey].server_session_seckey);var nonce1_dec=new Decimal(hex2dec.toDec(global.hybridd.xauth.session[session_hexkey].nonce1));var nonce2_dec=new Decimal(hex2dec.toDec(global.hybridd.xauth.session[session_hexkey].nonce2));var step_dec=new Decimal(session_step);var nonce_constr=nonce1_dec.plus(nonce2_dec).plus(step_dec);var nonce_convert=hex2dec.toHex(nonce_constr.toFixed(0).toString());var session_nonce=nacl.from_hex(nonce_convert.substr(2,nonce_convert.length));var payload=nacl.decode_utf8(nacl.crypto_box_open(crypt_bin,session_nonce,client_session_pubkey,server_session_seckey))}else{global.hybridd.xauth.session[session_hexkey].invalid=1;payload=null}return payload}else{if(typeof global.hybridd.xauth.session[session_hexkey]!=="undefined"){delete global.hybridd.xauth.session[session_hexkey]}return null}}
